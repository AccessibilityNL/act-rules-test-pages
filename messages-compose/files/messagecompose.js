!function(e,t){"use strict";var n=0,r=1e4,i=/^(?:#|\/?r\/)(.*)/,s=e.messagecompose={dom:{$form:t,$to:t,$subject:t,$rule:t,$other:t,$blank:t},rulesReq:t,rulesReqInProgressUrl:t,customSubject:t,init:function(){s.dom.$form=$("#compose-message"),s.dom.$to=s.dom.$form.find('[name="to"]'),s.dom.$subject=s.dom.$form.find('[name="subject"]'),s.dom.$rule=s.dom.$form.find("select.rule_subject"),s.dom.$other=s.dom.$rule.find("option.other"),s.dom.$blank=s.dom.$rule.find("option.blank");var n=new e.ui.Recaptcha({el:s.dom.$form[0],location:"messagecompose"});n.loadCaptcha(),s.dom.$form.length&&(s.dom.$form.on("submit",function(){var e=function(){$(document).off("ajaxSuccess.messagecompose",e),s.dom.$form.find(".error:visible").length==0&&(s.customSubject=t,s.onToUpdate(),s.dom.$subject.val("")),window.grecaptcha&&window.grecaptcha.reset()};$(document).on("ajaxSuccess.messagecompose",e)}),s.dom.$subject.val()&&(s.customSubject=s.dom.$subject.val()),s.dom.$to.length&&(s.dom.$to.change(s.onToUpdate),s.onToUpdate()),s.dom.$rule.change(s.onSelectedRuleChange),s.dom.$subject.change(s.onSubjectChange))},loadSubredditRules:function(n){var i="/r/"+n+"/about/rules.json";return s.rulesReqInProgressUrl===i?s.rulesReq:(s.rulesReq&&s.rulesReq.abort(),(s.rulesReq=e.ajax({url:i,type:"GET",dataType:"json",timeout:r})).always(function(){s.rulesReqInProgressUrl=t,s.rulesReq=t}).then(function(e,t,r){return!e.rules||e.kind==="Listing"?$.Deferred().reject(r,e,"No subreddit"):e.error?$.Deferred().reject(r,e,e.error):(e.sr_name=n,e)}),s.rulesReqInProgressUrl=i,s.rulesReq)},renderSubredditSubject:function(e){var t=function(e){return function(t){return t[e]}},r=_(e.rules).sortBy(t("priority")).map(t("short_name")).concat(e.site_rules);s.dom.$rule.find("option.rule").remove(),r.forEach(function(e){var t=document.createElement("option");$(t).val(e).text(e),t.className="rule",s.dom.$other.before(t)}),r.length&&(s.dom.$rule.show(n),_(r).contains(s.dom.$subject.val())?s.dom.$rule.val(s.dom.$subject.val()):/\S/.test(s.dom.$subject.val())||_(s.dom.$subject).contains(document.activeElement)||e.sr_name!=="reddit.com"?s.dom.$other.prop("selected",!0):(s.dom.$blank.show(),s.dom.$blank.prop("selected",!0))),s.dom.$rule.change()},renderGeneralSubject:function(){_(s.dom.$rule).contains(document.activeElement)&&s.dom.$subject.focus(),s.customSubject&&/\S/.test(s.customSubject)?s.dom.$subject.val(s.customSubject):s.dom.$rule.val(s.dom.$subject.val()),s.dom.$rule.hide(n),s.dom.$subject.show(n)},onToUpdate:function(){var e=s.dom.$to.val(),t=i.exec(e);t?s.loadSubredditRules(t[1]).then(s.renderSubredditSubject,s.renderGeneralSubject):s.renderGeneralSubject()},onSelectedRuleChange:function(e){e.target.options[e.target.selectedIndex]===s.dom.$other[0]?(s.customSubject&&/\S/.test(s.customSubject)&&s.dom.$subject.val(s.customSubject),s.dom.$subject.show(n),s.dom.$subject.focus()):(s.dom.$subject.hide(n),_(s.dom.$subject).contains(document.activeElement)&&s.dom.$rule.focus(),s.dom.$subject.val(s.dom.$rule.val())),e.target.options[e.target.selectedIndex]===s.dom.$blank[0]&&s.dom.$blank.hide()},onSubjectChange:function(e){s.customSubject=s.dom.$subject.val()}};e.hooks.get("reddit-init").register(e.messagecompose.init)}(r);